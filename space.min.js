function Space(a){this.keys=[];this.values={};this.events={};if("string"===typeof a)return this.loadFromString(a);if(a instanceof Space){this.keys=a.keys;for(var b in this.keys){var d=this.keys[b];this.values[d]=a.values[d]}return this}for(d in a)a.hasOwnProperty(d)&&(b=a[d],"object"===typeof b?this._set(d,new Space(b)):this._set(d,b));return this}Space.strRepeat=function(a,b){for(var d="",c=0;c<b;c++)d+=" ";return d};
Space.union=function(){var a=Space.unionSingle(arguments[0],arguments[1]),b;for(b in arguments)if(1!==b&&(a=Space.unionSingle(a,arguments[b]),!a.keys.length))break;return a};Space.unionSingle=function(a,b){var d=new Space;if(!(b instanceof Space))return d;for(var c in a.keys){var e=a.keys[c],f=a.values[e];f instanceof Space&&(b.values[e]&&b.values[e]instanceof Space)&&d._set(e,Space.unionSingle(f,b.values[e]));f===b.values[e]&&d._set(e,f)}return d};Space.prototype.keys=[];Space.prototype.values={};
Space.prototype.clear=function(){this.keys=[];this.values={};this.trigger("change");return this};Space.prototype.clone=function(){return new Space(this.toString())};Space.prototype._delete=function(a){if(!a.match(/ /)){var b=this.keys.indexOf(a);if(-1===b)return this;this.keys.splice(b,1);delete this.values[a];return this}b=a.split(/ /);a=b.pop();b=this.get(b.join(" "));b instanceof Space&&b._delete(a);return this};Space.prototype["delete"]=function(a){this._delete(a);this.trigger("change");return this};
Space.prototype.diff=function(a){var b=new Space;a instanceof Space||(a=new Space(a));for(var d in this.keys){var c=this.keys[d],e=a.values[c];"undefined"===typeof e?b._set(c,""):typeof this.values[c]!==typeof e?"object"===typeof e?b._set(c,new Space(e)):this.values[c]!=e&&b._set(c,e):"object"!==typeof this.values[c]?this.values[c]!=e&&b._set(c,e):(e=this.values[c].diff(e),e.keys.length&&b._set(c,e))}for(d in a.keys)c=a.keys[d],e=a.values[c],this.values[c]||("object"!==typeof e?b._set(c,e):e instanceof
Space?b._set(c,new Space(e)):b._set(c,new Space(a)));return b};Space.prototype.diffOrder=function(a){a instanceof Space||(a=new Space(a));var b=new Space,d;for(d in a.keys){var c=a.keys[d],e=a.values[c];e instanceof Space&&this.values[c]instanceof Space&&(e=this.values[c].diffOrder(e),e.empty()||b._set(c,e))}if(a.keys.join(" ")===this.keys.join(" "))return b;b.keys=a.keys;for(d in a.keys)c=a.keys[d],b.values.hasOwnProperty(c)||(b.values[c]=new Space);return b};
Space.prototype.each=function(a){for(var b in this.keys)a.call(this,this.keys[b],this.values[this.keys[b]]);return this};Space.prototype.empty=function(){return 0===this.keys.length};Space.prototype.every=function(a){for(var b in this.keys){var d=this.values[this.keys[b]];d instanceof Space&&d.every(a);a.call(this,this.keys[b],this.values[this.keys[b]])}return this};Space.prototype.get=function(a){switch(typeof a){case "string":return this.getByString(a);case "object":return this.getBySpace(a);case "number":return this.getByInt(a)}return null};
Space.prototype.getByInt=function(a){0>a&&(a=this.keys.length+a);return this.values[this.keys[a]]};Space.prototype.getByString=function(a){if(!a)return null;if(!a.match(/ /))return this.values[a];a=a.split(/ /g);var b=a.shift();return!(b in this.values)?null:this.values[b].get(a.join(" "))};
Space.prototype.getBySpace=function(a){var b=new Space,d;for(d in a.keys){var c=a.keys[d],e=this.values[c];"undefined"!==typeof e&&(!(a.values[c]instanceof Space)||!a.values[c].keys.length?b._set(c,e):e instanceof Space&&b._set(c,e.getBySpace(a.values[c])))}return b};Space.prototype.length=function(){return this.keys.length};
Space.prototype.loadFromString=function(a){a=a.replace(/^[\n ]*/,"");a=a.replace(/\n\r/g,"\n").replace(/\r\n/g,"\n");a=a.replace(/[\n ]*$/,"");a=a.replace(/\n\n+/,"\n");a=a.split(/\n(?! )/g);for(var b in a){var d=a[b];(matches=d.match(/^([^ ]+)(\n|$)/))?this._set(matches[1],new Space(d.substr(matches[1].length).replace(/\n /g,"\n"))):(matches=d.match(/^([^ ]+) /))&&this._set(matches[1],d.substr(matches[1].length+1).replace(/^\n /,"").replace(/\n /g,"\n"))}return this};
Space.prototype.next=function(a){a=this.keys.indexOf(a)+1;return this.keys[a]?this.keys[a]:this.keys[0]};Space.prototype.off=function(a,b){if(!this.events[a])return!0;for(var d in this.events[a])this.events[a][d]===b&&this.events[a].splice(d,1)};Space.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]);this.events[a].push(b)};
Space.prototype._patch=function(a){a instanceof Space||(a=new Space(a));for(var b in a.keys){var d=a.keys[b],c=a.values[d];"string"===typeof c?""===c?this._delete(d):this._set(d,c):"number"===typeof c?this._set(d,c):c instanceof Space&&!c.keys.length?this._delete(d):this.values[d]instanceof Space?this.values[d]._patch(c):this._set(d,new Space(c))}return this};Space.prototype.patch=function(a){this._patch(a);this.trigger("change");return this};
Space.prototype._patchOrder=function(a){a instanceof Space||(a=new Space(a));var b=this.keys.length,d;for(d in a.keys){var c=a.keys[d];if(!this.values.hasOwnProperty(c))break;b--}0===b&&(this.keys=a.keys);for(d in a.keys)c=a.keys[d],b=a.values[c],b instanceof Space&&(b.keys.length&&this.values[c]instanceof Space)&&this.values[c]._patchOrder(b);return this};Space.prototype.patchOrder=function(a){this._patchOrder(a);this.trigger("change");return this};
Space.prototype.prev=function(a){a=this.keys.indexOf(a)-1;return 0<=a?this.keys[a]:this.keys[this.keys.length-1]};Space.prototype._rename=function(a,b){this.values[b]=this.values[a];delete this.values[a];this.keys[this.keys.indexOf(a)]=b;return this};Space.prototype.rename=function(a,b){this._rename(a,b);this.trigger("change");return this};
Space.prototype._set=function(a,b,d){if(!a)return null;a=a.toString().split(/ /g);for(var c=this,e;e=a.shift();)void 0===c.values[e]&&("number"===typeof d?c.keys.splice(d,0,e):c.keys.push(e)),a.length?c.values[e]instanceof Space||(c.values[e]=new Space):c.values[e]=b,c=c.values[e];return this};Space.prototype.set=function(a,b,d){this._set(a,b,d);this.trigger("change");return this};
Space.prototype.toJavascript=function(){return"new Space('"+this.toString().replace(/\n/g,"\\n").replace(/\'/g,"\\'")+"')"};Space.prototype.toJSON=function(){return JSON.stringify(this.toObject())};Space.prototype.toObject=function(){var a={},b;for(b in this.keys){var d=this.keys[b],c=this.values[d];a[d]=c instanceof Space?c.toObject():c}return a};
Space.prototype.toString=function(a){a=a||0;var b="",d;for(d in this.keys){var c=this.keys[d],e=this.values[c];"undefined"===typeof e?b+="\n":(b+=Space.strRepeat(" ",a)+c,b=e instanceof Space?b+("\n"+e.toString(a+1)):"object"===typeof e?b+("\n"+(new Space(e)).toString(a+1)):""===e.toString()?b+"\n":e.toString().match(/\n/)?b+(" \n"+Space.strRepeat(" ",a+1)+e.toString().replace(/\n/g,"\n"+Space.strRepeat(" ",a+1))+"\n"):b+(" "+e.toString()+"\n"))}return b};
Space.prototype.trigger=function(a){if(!this.events[a])return!0;for(var b in this.events[a])this.events[a][b].apply(this,arguments)};"undefined"!=typeof exports&&(module.exports=Space);
