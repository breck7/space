function Space(a){this.keys=[];this.values={};this.events={};this._parse(a);return this}Space.pathBranch=function(a){a=a.split(/ /g);if(2>a.length)return"";a.pop();return a.join(" ")};Space.pathLeaf=function(a){var b=a.split(/ /g);return 2>b.length?a:b[b.length-1]};Space.strRepeat=function(a,b){for(var c="",d=0;d<b;d++)c+=" ";return c};
Space.union=function(){var a=Space.unionSingle(arguments[0],arguments[1]),b;for(b in arguments)if(1!==b&&(a=Space.unionSingle(a,arguments[b]),!a.keys.length))break;return a};Space.unionSingle=function(a,b){var c=new Space;if(!(b instanceof Space))return c;for(var d in a.keys){var e=a.keys[d],f=a.values[e];f instanceof Space&&(b.values[e]&&b.values[e]instanceof Space)&&c._set(e,Space.unionSingle(f,b.values[e]));f===b.values[e]&&c._set(e,f)}return c};Space.prototype.keys=[];Space.prototype.values={};
Space.prototype.append=function(a,b){this._set(a,b);this.trigger("append",a,b);this.trigger("change");return this};Space.prototype._clear=function(){this.keys=[];this.values={};return this};Space.prototype.clear=function(a){if(this.isEmpty())return this;this._clear();this.trigger("clear");a&&this._parse(a);this.trigger("change");return this};Space.prototype.clone=function(){return new Space(this.toString())};
Space.prototype.create=function(a,b){this._set(a,b);this.trigger("create",a,b);this.trigger("change");return this};Space.prototype._delete=function(a){if(!a.toString().match(/ /)){var b=this.keys.indexOf(a);if(-1===b)return 0;this.keys.splice(b,1);delete this.values[a];return 1}b=a.split(/ /);a=b.pop();b=this.get(b.join(" "));return b instanceof Space?b._delete(a):0};Space.prototype["delete"]=function(a){this._delete(a)&&this.trigger("delete",a);this.trigger("change");return this};
Space.prototype.diff=function(a){var b=new Space;a instanceof Space||(a=new Space(a));for(var c in this.keys){var d=this.keys[c],e=a.values[d];"undefined"===typeof e?b._set(d,""):typeof this.values[d]!==typeof e?"object"===typeof e?b._set(d,new Space(e)):this.values[d]!=e&&b._set(d,e):"object"!==typeof this.values[d]?this.values[d]!=e&&b._set(d,e):(e=this.values[d].diff(e),e.keys.length&&b._set(d,e))}for(c in a.keys)d=a.keys[c],e=a.values[d],this.values[d]||("object"!==typeof e?b._set(d,e):e instanceof
Space?b._set(d,new Space(e)):b._set(d,new Space(a)));return b};Space.prototype.diffOrder=function(a){a instanceof Space||(a=new Space(a));var b=new Space,c;for(c in a.keys){var d=a.keys[c],e=a.values[d];e instanceof Space&&this.values[d]instanceof Space&&(e=this.values[d].diffOrder(e),e.isEmpty()||b._set(d,e))}if(a.keys.join(" ")===this.keys.join(" "))return b;b.keys=a.keys;for(c in a.keys)d=a.keys[c],b.values.hasOwnProperty(d)||(b.values[d]=new Space);return b};
Space.prototype.each=function(a){for(var b in this.keys)if(!1===a.call(this,this.keys[b],this.values[this.keys[b]]))break;return this};Space.prototype.isEmpty=function(){return 0===this.keys.length};Space.prototype.every=function(a){for(var b in this.keys){var c=this.values[this.keys[b]];c instanceof Space&&c.every(a);a.call(this,this.keys[b],this.values[this.keys[b]])}return this};
Space.prototype.get=function(a){switch(typeof a){case "string":return this.getByString(a);case "object":return this.getBySpace(a);case "number":return this.getByInt(a)}return null};Space.prototype.getByInt=function(a){0>a&&(a=this.keys.length+a);return this.values[this.keys[a]]};Space.prototype.getByString=function(a){if(a){if(!a.match(/ /))return this.values[a];a=a.split(/ /g);var b=a.shift();if(b in this.values&&this.values[b]instanceof Space)return this.values[b].get(a.join(" "))}};
Space.prototype.getBySpace=function(a){var b=new Space,c;for(c in a.keys){var d=a.keys[c],e=this.values[d];"undefined"!==typeof e&&(!(a.values[d]instanceof Space)||!a.values[d].keys.length?b._set(d,e):e instanceof Space&&b._set(d,e.getBySpace(a.values[d])))}return b};
Space.prototype.getTokens=function(a){for(var b=this.toString(),c="K",d="",e=1,f=0,g=0;g<b.length-1;g++){var h=b.substr(g,1);a&&console.log("map: %s; mode: %s; char: %s",d,c,h);0<f?(d+="E",f--):" "!==h&&"\n"!==h?("N"===c&&(c="K"),d+=c):" "===h?"V"===c?d+=c:"K"===c?(d+="S",c="V"):(e++,d+="N"):"K"===c?(c="N",e=1,d+="N"):"V"===c&&(b.substr(g+1,e)===Space.strRepeat(" ",e)?(d+="V",f=e):(c="N",e=1,d+="N"))}return d};
Space.prototype.getTokensConcise=function(){return this.getTokens().replace(/[^\w\s]|(.)(?=\1)/gi,"")};Space.prototype.keyCount=function(){var a=this.length();this.each(function(b,c){c instanceof Space&&(a+=c.keyCount())});return a};Space.prototype.length=function(){return this.keys.length};Space.prototype.next=function(a){a=this.keys.indexOf(a)+1;return this.keys[a]?this.keys[a]:this.keys[0]};
Space.prototype.off=function(a,b){if(!this.events[a])return!0;for(var c in this.events[a])this.events[a][c]===b&&this.events[a].splice(c,1)};Space.prototype.objectCount=function(){var a=0;this.each(function(b,c){c instanceof Space&&(a+=1+c.objectCount())});return a};Space.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]);this.events[a].push(b)};
Space.prototype._parse=function(a){if("string"===typeof a)return this._parseFromString(a);if(a instanceof Space){this.keys=a.keys;for(var b in this.keys){var c=this.keys[b];this.values[c]=a.values[c]}return this}for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b=a[c],"object"===typeof b?this._set(c,new Space(b)):this._set(c,b))};
Space.prototype._parseFromString=function(a){a=a.replace(/^[\n ]*/,"");a=a.replace(/\n\r/g,"\n").replace(/\r\n/g,"\n");a=a.replace(/\n[\n ]*$/,"");a=a.replace(/\n\n+/,"\n");a=a.split(/\n(?! )/g);for(var b in a){var c=a[b];(matches=c.match(/^([^ ]+)(\n|$)/))?this._set(matches[1],new Space(c.substr(matches[1].length).replace(/\n /g,"\n"))):(matches=c.match(/^([^ ]+) /))&&this._set(matches[1],c.substr(matches[1].length+1).replace(/^\n /,"").replace(/\n /g,"\n"))}return this};
Space.prototype._patch=function(a){a instanceof Space||(a=new Space(a));for(var b in a.keys){var c=a.keys[b],d=a.values[c];"string"===typeof d?""===d?this._delete(c):this._set(c,d):"number"===typeof d?this._set(c,d):d instanceof Space&&!d.keys.length?this._delete(c):this.values[c]instanceof Space?this.values[c]._patch(d):this._set(c,new Space(d))}return this};Space.prototype.patch=function(a){this._patch(a);this.trigger("patch",a);this.trigger("change");return this};
Space.prototype._patchOrder=function(a){a instanceof Space||(a=new Space(a));var b=this.keys.length,c;for(c in a.keys){var d=a.keys[c];if(!this.values.hasOwnProperty(d))break;b--}0===b&&(this.keys=a.keys);for(c in a.keys)d=a.keys[c],b=a.values[d],b instanceof Space&&(b.keys.length&&this.values[d]instanceof Space)&&this.values[d]._patchOrder(b);return this};Space.prototype.patchOrder=function(a){this._patchOrder(a);this.trigger("patchOrder",a);this.trigger("change");return this};
Space.prototype.pop=function(){if(!this.keys.length)return null;var a=this.keys.pop(),b=new Space;b.set(a,this.get(a));this._delete(a);return b};Space.prototype.prev=function(a){a=this.keys.indexOf(a)-1;return 0<=a?this.keys[a]:this.keys[this.keys.length-1]};Space.prototype._rename=function(a,b){this.values[b]=this.values[a];delete this.values[a];this.keys[this.keys.indexOf(a)]=b;return this};
Space.prototype.rename=function(a,b){var c=Space.pathBranch(a),d=Space.pathLeaf(a),e=b,f=this;c&&(f=this.get(c),e=b.substr(c.length+1));f._rename(d,e);a!==b&&this.trigger("rename",a,b);this.trigger("change");return this};
Space.prototype._set=function(a,b,c){if(!a)return null;a=a.toString().split(/ /g);for(var d=this,e;e=a.shift();)void 0===d.values[e]&&("number"===typeof c?d.keys.splice(c,0,e):d.keys.push(e)),a.length?d.values[e]instanceof Space||(d.values[e]=new Space):d.values[e]=b,d=d.values[e];return this};Space.prototype.set=function(a,b,c){this.get(a);this._set(a,b,c);this.trigger("set",a,b,c);this.trigger("change");return this};
Space.prototype.toJavascript=function(){return"new Space('"+this.toString().replace(/\n/g,"\\n").replace(/\'/g,"\\'")+"')"};Space.prototype.toJSON=function(){return JSON.stringify(this.toObject())};Space.prototype.toObject=function(){var a={},b;for(b in this.keys){var c=this.keys[b],d=this.values[c];a[c]=d instanceof Space?d.toObject():d}return a};
Space.prototype.toString=function(a){a=a||0;var b="",c;for(c in this.keys){var d=this.keys[c],e=this.values[d];"undefined"===typeof e?b+="\n":(b+=Space.strRepeat(" ",a)+d,b=e instanceof Space?b+("\n"+e.toString(a+1)):"object"===typeof e?b+("\n"+(new Space(e)).toString(a+1)):""===e.toString()?b+" \n":e.toString().match(/\n/)?b+(" \n"+Space.strRepeat(" ",a+1)+e.toString().replace(/\n/g,"\n"+Space.strRepeat(" ",a+1))+"\n"):b+(" "+e.toString()+"\n"))}return b};Space.prototype.toURL=function(){return encodeURIComponent(this.toString())};
Space.prototype.trigger=function(a){if(!this.events[a])return!0;var b=Array.prototype.slice.call(arguments),c;for(c in this.events[a])this.events[a][c].apply(this,b.slice(1))};"undefined"!=typeof exports&&(module.exports=Space);
