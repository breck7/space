function Space(a){this._pairs=[];this.events={};this._load(a);return this}Space.version="0.5.4";Space.arrayDelete=function(a,b){return a.slice(0,b).concat(a.slice(b+1))};Space.isXPath=function(a){return a.match(/ /)};Space.pathBranch=function(a){a=a.split(/ /g);if(2>a.length)return"";a.pop();return a.join(" ")};Space.pathLeaf=function(a){var b=a.split(/ /g);return 2>b.length?a:b[b.length-1]};Space.strRepeat=function(a,b){for(var c="",d=0;d<b;d++)c+=" ";return c};
Space.union=function(){var a=Space.unionSingle(arguments[0],arguments[1]),b;for(b in arguments)if(1!==b&&(a=Space.unionSingle(a,arguments[b]),!a.length()))break;return a};Space.unionSingle=function(a,b){var c=new Space;if(!(b instanceof Space))return c;a.each(function(a,e){e instanceof Space&&(b._getValueByKey(a)&&b._getValueByKey(a)instanceof Space)&&c._setPair(a,Space.unionSingle(e,b._getValueByKey(a)));e===b._getValueByKey(a)&&c._setPair(a,e)});return c};
Space.prototype.append=function(a,b){this._setPair(a,b);this.trigger("append",a,b);this.trigger("change");return this};Space.prototype._clear=function(){this._pairs=[];return this};Space.prototype.clear=function(a){if(this.isEmpty())return this;this._clear();this.trigger("clear");a&&this._load(a);this.trigger("change");return this};Space.prototype.clone=function(){return new Space(this.toString())};
Space.prototype.concat=function(a){"string"===typeof a&&(a=new Space(a));var b=this;a.each(function(a,d){b.append(a,d)});return this};Space.prototype.create=function(a,b){this._setPair(a,b);this.trigger("create",a,b);this.trigger("change");return this};Space.prototype._delete=function(a){if(!a.toString().match(/ /)){a=this.indexOf(a);if(-1===a)return 0;this._deletePair(a);return 1}var b=a.split(/ /);a=b.pop();b=this.get(b.join(" "));return b instanceof Space?b._delete(a):0};
Space.prototype["delete"]=function(a){this._delete(a)&&this.trigger("delete",a);this.trigger("change");return this};Space.prototype._deletePair=function(a){this._pairs.splice(a,1)};
Space.prototype.diff=function(a){var b=new Space;a instanceof Space||(a=new Space(a));this.each(function(d){var c=a._getValueByKey(d);if("undefined"===typeof c)return b._setPair(d,""),!0;if(typeof this._getValueByKey(d)!==typeof c)return"object"===typeof c?b._setPair(d,new Space(c)):this._getValueByKey(d)!=c&&b._setPair(d,c),!0;if("object"!==typeof this._getValueByKey(d))return this._getValueByKey(d)!=c&&b._setPair(d,c),!0;c=this._getValueByKey(d).diff(c);c.length()&&b._setPair(d,c)});var c=this;
a.each(function(d,e){if(c.has(d))return!0;if("object"!==typeof e)return b._setPair(d,e),!0;e instanceof Space?b._setPair(d,new Space(e)):b._setPair(d,new Space(a))});return b};
Space.prototype.diffOrder=function(a){a instanceof Space||(a=new Space(a));var b=new Space,c=this;a.each(function(a,e){if(!(e instanceof Space)||!(c._getValueByKey(a)instanceof Space))return!0;var f=c._getValueByKey(a).diffOrder(e);if(f.isEmpty())return!0;b._setPair(a,f)});if(a.tableOfContents()===this.tableOfContents())return b;a.each(function(a){b.has(a)||b._setPair(a,new Space)});return b};
Space.prototype.each=function(a){for(var b in this._pairs)if(!1===a.call(this,this._pairs[b][0],this._pairs[b][1],b))break;return this};Space.prototype.filter=function(a){var b=new Space,c;for(c in this._pairs)!0===a.call(this,this._pairs[c][0],this._pairs[c][1],c)&&b.append(this._pairs[c][0],this._pairs[c][1]);return b};
Space.prototype.find=function(a,b){var c=new Space;this.get(a)===b&&c.push(this);this.each(function(d,e){if(!(e instanceof Space))return!0;e.find(a,b).each(function(a,b){c.push(b)})});return c};Space.prototype.every=function(a){this.each(function(b,c,d){a.call(this,b,c,d);c instanceof Space&&c.every(a)});return this};Space.prototype.get=function(a){return this._getValueByString(a.toString())};
Space.prototype.getAll=function(a){var b=new Space;this.each(function(c,d){if(c!==a)return!0;b.append(c,d)});return b};Space.prototype.getByIndex=function(a){return this._getValueByIndex(a)};Space.prototype.getByIndexPath=function(a){a=a.split(/ /g);var b=parseFloat(a.shift());return 0===a.length?this._getValueByIndex(b):this._getValueByIndex(b).getByIndexPath(a.join(" "))};Space.prototype.getBySpace=function(a){return this._getValueBySpace(a)};
Space.prototype._getValueByIndex=function(a){0>a&&(a=this.length()+a);if(this._pairs[a])return this._pairs[a][1]};Space.prototype._getValueByKey=function(a){var b;this._pairs.forEach(function(c){if(c[0]===a)return b=c[1],!1});return b};Space.prototype._getKeyByIndex=function(a){0>a&&(a=this.length()+a);return this.getKeys()[a]};Space.prototype.getKeys=function(){var a=[];this._pairs.forEach(function(b){a.push(b[0])});return a};
Space.prototype._getValueByString=function(a){if(a){if(!a.match(/ /))return this._getValueByKey(a);a=a.split(/ /g);var b=a.shift();if(this.has(b)&&this._getValueByKey(b)instanceof Space)return this._getValueByKey(b).get(a.join(" "))}};
Space.prototype._getValueBySpace=function(a){var b=new Space,c=this;a.each(function(d){var e=c._getValueByKey(d);if("undefined"===typeof e)return!0;if(!(a._getValueByKey(d)instanceof Space)||!a._getValueByKey(d).length())return b._setPair(d,e),!0;if(!(e instanceof Space))return!0;b._setPair(d,e._getValueBySpace(a._getValueByKey(d)))});return b};
Space.prototype.getTokens=function(a){for(var b=this.toString(),c="K",d="",e=1,f=0,g=0;g<b.length-1;g++){var h=b.substr(g,1);a&&console.log("map: %s; mode: %s; char: %s",d,c,h);0<f?(d+="E",f--):" "!==h&&"\n"!==h?("N"===c&&(c="K"),d+=c):" "===h?"V"===c?d+=c:"K"===c?(d+="S",c="V"):(e++,d+="N"):"K"===c?(c="N",e=1,d+="N"):"V"===c&&(b.substr(g+1,e)===Space.strRepeat(" ",e)?(d+="V",f=e):(c="N",e=1,d+="N"))}return d};
Space.prototype.getTokensConcise=function(){return this.getTokens().replace(/[^\w\s]|(.)(?=\1)/gi,"")};Space.prototype.has=function(a){return void 0!==this._getValueByKey(a)};Space.prototype.indexOf=function(a){return this.getKeys().indexOf(a)};Space.prototype.insert=function(a,b,c){this._setPair(a,b,c);return this};Space.prototype.isEmpty=function(){return 0===this.length()};
Space.prototype.isASet=function(){var a=!0,b={};this.each(function(c,d){if(b[c])return a=!1;b[c]=!0;if(d instanceof Space)return d.isASet()?!0:a=!1});return a};Space.prototype._keyCount=function(){var a=this.length();this.each(function(b,c){c instanceof Space&&(a+=c._keyCount())});return a};Space.prototype.length=function(){return this.getKeys().length};
Space.prototype._load=function(a){if("string"===typeof a)return this._loadFromString(a);if(a instanceof Space){var b=this;a.each(function(a,c){b._setPair(a,c)});return this}for(var c in a)if(Object.prototype.hasOwnProperty.call(a,c)){var d=a[c];"object"===typeof d?this._setPair(c,new Space(d)):this._setPair(c,d)}};
Space.prototype._loadFromString=function(a){a=a.replace(/^[\n ]*/,"");a=a.replace(/\n\r/g,"\n").replace(/\r\n/g,"\n");a=a.replace(/\n\n+/,"\n");a=a.split(/\n(?! )/g);var b,c;for(c in a){var d=a[c];(b=d.match(/^([^ ]+)(\n|$)/))?this._setPair(b[1],new Space(d.substr(b[1].length).replace(/\n /g,"\n"))):(b=d.match(/^([^ ]+) /))&&this._setPair(b[1],d.substr(b[1].length+1).replace(/\n /g,"\n"))}return this};Space.prototype.next=function(a){a=this.indexOf(a)+1;return this._getKeyByIndex(a)};
Space.prototype.off=function(a,b){if(!this.events[a])return!0;for(var c in this.events[a])this.events[a][c]===b&&this.events[a].splice(c,1)};Space.prototype._objectCount=function(){var a=0;this.each(function(b,c){c instanceof Space&&(a+=1+c._objectCount())});return a};Space.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]);this.events[a].push(b)};
Space.prototype._patch=function(a){a instanceof Space||(a=new Space(a));var b=this;a.each(function(a,d){if("string"===typeof d)return""===d?b._delete(a):b._setPair(a,d),!0;if("number"===typeof d)return b._setPair(a,d),!0;if(d instanceof Space&&!d.length())return b._delete(a),!0;if(b._getValueByKey(a)instanceof Space)return b._getValueByKey(a)._patch(d),!0;b._setPair(a,new Space(d))});return this};Space.prototype.patch=function(a){this._patch(a);this.trigger("patch",a);this.trigger("change");return this};
Space.prototype._patchOrder=function(a){a instanceof Space||(a=new Space(a));var b=this,c=this.clone();b._clear();a.each(function(a,e){b._setPair(a,c.get(a));e instanceof Space&&(e.length()&&c._getValueByKey(a)instanceof Space)&&b._getValueByKey(a)._patchOrder(e)});return this};Space.prototype.patchOrder=function(a){this._patchOrder(a);this.trigger("patchOrder",a);this.trigger("change");return this};
Space.prototype.pop=function(){if(!this.length())return null;var a=new Space,b=this._getKeyByIndex(-1),c=this._getValueByKey(b);a.set(b,c);this._delete(b);return a};Space.prototype.prepend=function(a,b){return this._setPair(a,b,0)};Space.prototype.prev=function(a){a=this.indexOf(a)-1;return this._getKeyByIndex(a)};Space.prototype.push=function(a){for(var b=this.length();this.get(b.toString());)b++;this._setPair(b.toString(),a);return this};
Space.prototype._rename=function(a,b){var c=this.indexOf(a);this._setPair(b,this._getValueByKey(a),c,!0);return this};Space.prototype.reload=function(a){this._pairs=[];this._load(a);this.trigger("reload");return this};Space.prototype.rename=function(a,b){this._rename(a,b);a!==b&&this.trigger("rename",a,b);this.trigger("change");return this};
Space.prototype.set=function(a,b,c){a=a.toString();Space.isXPath(a)?this._setByXPath(a,b):this.has(a)?this._setPair(a,b,this.indexOf(a),!0):this._setPair(a,b,c);this.trigger("set",a,b,c);this.trigger("change");return this};Space.prototype.setByIndexPath=function(a,b){if(!Space.isXPath(a)){var c=parseFloat(a);this.update(c,this._getKeyByIndex(c),b);return this}c=Space.pathBranch(a);c=this.getByIndexPath(c);if(!c)return this;var d=parseFloat(Space.pathLeaf(a));c.update(d,c._getKeyByIndex(d),b);return this};
Space.prototype._setByXPath=function(a,b){if(!a)return null;for(var c=a.toString().split(/ /g),d=this,e,f,g=0;g<c.length;g++){e=c[g];if(!(d._getValueByKey(e)instanceof Space)){var h;h=g===c.length-1?b:new Space;d.has(e)?(f=d.indexOf(e),d._setPair(e,h,f,!0)):d._setPair(e,h)}d=d.get(e)}return this};Space.prototype._setPair=function(a,b,c,d){a=a.toString();void 0===c?this._pairs.push([a,b]):d?this._pairs.splice(c,1,[a,b]):this._pairs.splice(c,0,[a,b])};
Space.prototype.shift=function(){if(!this.length())return null;var a=this._getKeyByIndex(0),b=new Space;b.set(a,this.get(a));this._delete(a);return b};Space.prototype.sort=function(a){this._pairs=this._pairs.sort(a);return this};Space.prototype.tableOfContents=function(){return this.getKeys().join(" ")};
Space.prototype.toBinary=function(){for(var a="",b=this.toString(),c=0;c<b.length;c++){for(var d=parseFloat(b.substr(c,1).charCodeAt(0)).toString(2);8>d.length;)d="0"+d;a+=d}return a.replace(/0/g,"-").replace(/1/g,"|")};Space.prototype.toJavascript=function(a){var b="new Space('"+this.toString().replace(/\n/g,"\\n").replace(/\'/g,"\\'")+"')";return a?b.replace(/\\n/g,"\\n\\\n"):b};Space.prototype.toJSON=function(){return JSON.stringify(this.toObject())};
Space.prototype.toObject=function(){var a={};this.each(function(b,c){a[b]=c instanceof Space?c.toObject():c});return a};Space.prototype.toQueryString=function(){var a="",b="";this.each(function(c,d){a+=b+encodeURIComponent(c)+"="+encodeURIComponent(d);b="&"});return a};
Space.prototype.toShapes=function(a){a=a||0;var b="V\n";this.each(function(c,d){if("undefined"===typeof d)return b+="\n",!0;b+=Space.strRepeat(" ",a)+"O";b=d instanceof Space?b+d.toShapes(a+1):"object"===typeof d?b+(new Space(d)).toShapes(a+1):""===d.toString()?b+" \n":b+"[]\n"});return b};
Space.prototype.toString=function(a){a=a||0;var b="";this.each(function(c,d){if("undefined"===typeof d)return b+="\n",!0;b+=Space.strRepeat(" ",a)+c;b=d instanceof Space?b+("\n"+d.toString(a+1)):"object"===typeof d?b+("\n"+(new Space(d)).toString(a+1)):""===d.toString()?b+" \n":d.toString().match(/\n/)?b+(" "+d.toString().replace(/\n/g,"\n"+Space.strRepeat(" ",a+1))+"\n"):b+(" "+d.toString()+"\n")});return b};Space.prototype.toURL=function(){return encodeURIComponent(this.toString())};
Space.prototype.__transpose=function(a){var b="";this.each(function(c,d){var e=new Space(a.toString());e.every(function(a,b,c){d._getValueByKey(b)&&this._setPair(a,d._getValueByKey(b),c,!0)});b+=e.toString()});return new Space(b)};Space.prototype.trigger=function(a){if(!this.events[a])return!0;var b=Array.prototype.slice.call(arguments),c;for(c in this.events[a])this.events[a][c].apply(this,b.slice(1))};Space.prototype.update=function(a,b,c){this._setPair(b,c,a,!0);return this};
"undefined"!=typeof exports&&(module.exports=Space);
