function Space(a){this._pairs=[];this._index={};this._cache={};this.events={};this._load(a);return this}Space.version="0.8.11";Space.removeItems=function(a,b){var c=[];"number"===typeof b&&(b=[b]);for(var d=b.length-1;0<=d;d--)c.push(a.splice(b[d],1));return c};Space.isXPath=function(a){return a.match(/ /)};
Space.fromHeredoc=function(a,b,c){a=a.replace(/\n\r/g,"\n");a=a.split("\n");var d=null,e=[],f=RegExp("^"+b+"(?: |$)"),h=a.length;b=b.length;c=RegExp("^"+c);for(var g=0;g<h;g++)null===d?a[g].match(f)&&(d=g,a[g].length===b&&(a[g]+=" ")):a[g].match(c)?(d=null,e.push(g)):a[g]=" "+a[g];Space.removeItems(a,e);return new Space(a.join("\n"))};
Space.fromFile=function(a,b,c){if("undefined"===typeof require)throw Error("fromFile only works with node.js");"undefined"===typeof fs&&(fs=require("fs"));"function"===typeof b&&(c=b,b=null);b||(b="utf8");return!c?new Space(fs.readFileSync(a,b)):fs.readFile(a,b,function(a,b){return a?c(a):c(a,new Space(b))})};
Space.toFile=function(a,b,c,d,e){if("undefined"===typeof require)throw Error("toFile only works with node.js");"undefined"===typeof fs&&(fs=require("fs"));"function"===typeof c&&(d=c,c=null);return!e&&!d?fs.writeFileSync(a,b.toString(),c):fs.writeFile(a,b.toString(),c,d)};
Space._ajaxRequest=function(a,b,c){var d=new XMLHttpRequest;d.onreadystatechange=function(){4==d.readyState&&200==d.status?b(new Space(d.responseText)):4==d.readyState&&b(null,"Error Code: "+d.status+". "+d.statusText)};d.open(c?"POST":"GET",a,!0);c&&d.setRequestHeader("Content-type","text/plain");d.send(c?c.toString():null)};
Space._nodeRequest=function(a,b,c){"undefined"===typeof request&&(request=require("request"));return c?request.post({url:a,formData:c.toString()},b):request.get(a,function(a,c,f){if(a)return b(null,a);b(new Space(f))})};Space._isNode=function(){return"undefined"!==typeof require};Space.fromUrl=function(a,b){Space._isNode()?Space._nodeRequest(a,b):Space._ajaxRequest(a,b)};Space.toUrl=function(a,b,c){Space._isNode()?Space._nodeRequest(a,c,b):Space._ajaxRequest(a,c,b)};
Space.pathBranch=function(a){a=a.split(/ /g);if(2>a.length)return"";a.pop();return a.join(" ")};Space.pathLeaf=function(a){var b=a.split(/ /g);return 2>b.length?a:b[b.length-1]};Space.strRepeat=function(a,b){for(var c="",d=0;d<b;d++)c+=a;return c};Space.union=function(){for(var a=Space.unionSingle(arguments[0],arguments[1]),b=arguments.length,c=0;c<b&&!(1!==c&&(a=Space.unionSingle(a,arguments[c]),!a.length()));c++);return a};
Space.unionSingle=function(a,b){var c=new Space;if(!(b instanceof Space))return c;a.each(function(a,e){e instanceof Space&&(b._getValueByProperty(a)&&b._getValueByProperty(a)instanceof Space)&&c._setPair(a,Space.unionSingle(e,b._getValueByProperty(a)));e===b._getValueByProperty(a)&&c._setPair(a,e)});return c};Space.prototype.append=function(a,b){this._setPair(a,b);this.trigger("append",a,b);this.trigger("change");return this};
Space.prototype._clear=function(){this._pairs=[];this._index={};this._cache={};return this};Space.prototype.clear=function(a){if(this.isEmpty())return this;this._clear();this.trigger("clear");a&&this._load(a);this.trigger("change");return this};Space.prototype.clearListeners=function(a){if(a)delete this.events[a];else for(a in this.events)this.events.hasOwnProperty(a)&&delete this.events[a];return this};Space.prototype.clone=function(){return new Space(this.toString())};
Space.prototype.concat=function(a){"string"===typeof a&&(a=new Space(a));var b=this;a.each(function(a,d){b.append(a,d)});return this};Space.prototype.create=function(a,b){this._setPair(a,b);this.trigger("create",a,b);this.trigger("change");return this};Space.prototype._delete=function(a){return"number"===typeof a?this._deleteByIndex(a):a.toString().match(/ /)?this._deleteByXPath(a):this._deleteByProperty(a)};
Space.prototype._deleteByIndex=function(a){if(void 0===this._pairs[a])return 0;var b=this._pairs.splice(a,1),c=b[0][0];this._index[c]--;if(this._index[c]){if(b[0][1]===this._cache[c])for(b=this.length();a<b;a++)if(this._pairs[a][0]===c){this._cache[c]=this._pairs[a][1];break}}else delete this._cache[c],delete this._index[c];return 1};Space.prototype._deleteByProperty=function(a){a=this.indexOf(a);return-1===a?0:this._deleteByIndex(a)};
Space.prototype._deleteByXPath=function(a){var b=a.split(/ /);a=b.pop();b=this.get(b.join(" "));return b instanceof Space?b._delete(a):0};Space.prototype["delete"]=function(a){this._delete(a)&&this.trigger("delete",a);this.trigger("change");return this};
Space.prototype.diff=function(a){var b=new Space;a instanceof Space||(a=new Space(a));this.each(function(c){var e=a._getValueByProperty(c);if("undefined"===typeof e)return b._setPair(c,""),!0;if(typeof this._getValueByProperty(c)!==typeof e)return"object"===typeof e?b._setPair(c,new Space(e)):this._getValueByProperty(c)!=e&&b._setPair(c,e),!0;if("object"!==typeof this._getValueByProperty(c))return this._getValueByProperty(c)!=e&&b._setPair(c,e),!0;e=this._getValueByProperty(c).diff(e);e.length()&&
b._setPair(c,e)});var c=this;a.each(function(d,e){if(c.has(d))return!0;if("object"!==typeof e)return b._setPair(d,e),!0;e instanceof Space?b._setPair(d,new Space(e)):b._setPair(d,new Space(a))});return b};
Space.prototype.diffOrder=function(a){a instanceof Space||(a=new Space(a));var b=new Space,c=this;a.each(function(a,e){if(!(e instanceof Space)||!(c._getValueByProperty(a)instanceof Space))return!0;var f=c._getValueByProperty(a).diffOrder(e);if(f.isEmpty())return!0;b._setPair(a,f)});if(a.tableOfContents()===this.tableOfContents())return b;a.each(function(a){b.has(a)||b._setPair(a,new Space)});return b};
Space.prototype.each=function(a){for(var b=this._pairs.length,c=0;c<b&&!1!==a.call(this,this._pairs[c][0],this._pairs[c][1],c);c++);return this};Space.prototype.filter=function(a){for(var b=new Space,c=this._pairs.length,d=0;d<c;d++)!0===a.call(this,this._pairs[d][0],this._pairs[d][1],d)&&b.append(this._pairs[d][0],this._pairs[d][1]);return b};
Space.prototype.find=function(a,b){var c=new Space;this.get(a)===b&&c.push(this);this.each(function(d,e){if(!(e instanceof Space))return!0;e.find(a,b).each(function(a,b){c.push(b)})});return c};Space.prototype.first=function(){return!this.length()?new Space:(new Space).set(this._pairs[0][0],this._pairs[0][1])};Space.prototype.firstProperty=function(){return!this.length()?null:this._pairs[0][0]};Space.prototype.firstValue=function(){return!this.length()?null:this._pairs[0][1]};
Space.prototype.every=function(a){this.each(function(b,c,d){a.call(this,b,c,d);c instanceof Space&&c.every(a)});return this};Space.prototype.get=function(a){return this._getValueByString(a.toString())};Space.prototype.getAll=function(a){var b=new Space;this.each(function(c,d){if(c!==a)return!0;b.append(c,d)});return b};Space.prototype.getArray=function(a){var b=[];this.each(function(c,d){if(c!==a)return!0;b.push(d)});return b};Space.prototype.getByIndex=function(a){return this._getValueByIndex(a)};
Space.prototype.getByIndexPath=function(a){a=a.split(/ /g);var b=parseFloat(a.shift());return 0===a.length?this._getValueByIndex(b):this._getValueByIndex(b).getByIndexPath(a.join(" "))};Space.prototype.getBySpace=function(a){return this._getValueBySpace(a)};
Space.prototype.getCud=function(a){var b=new Space("created\nupdated\ndeleted\n");a instanceof Space||(a=new Space(a));var c=this;a.each(function(a,e){void 0===c.get(a)?b.set("created "+a,e):c.get(a).toString()!==e.toString()&&b.set("updated "+a,e)});this.each(function(c){void 0===a.get(c)&&b.set("deleted "+c,new Space)});return b};Space.prototype._getValueByIndex=function(a){0>a&&(a=this.length()+a);if(this._pairs[a])return this._pairs[a][1]};Space.prototype._getValueByProperty=function(a){return this._cache[a]};
Space.prototype._getPropertyByIndex=function(a){var b=this.length();0>a&&(a=b+a);return a>=b?void 0:this._pairs[a][0]};Space.prototype.getProperties=function(){var a=[];this._pairs.forEach(function(b){a.push(b[0])});return a};Space.prototype._getValueByString=function(a){if(a){var b=this._getValueByProperty(a);if(b||""===b||0===b||!1===b)return b;if(a.match(/ /)&&(a=a.split(/ /g),b=a.shift(),this.has(b)&&this._getValueByProperty(b)instanceof Space))return this._getValueByProperty(b).get(a.join(" "))}};
Space.prototype._getValueBySpace=function(a){var b=new Space,c=this;a.each(function(d){var e=c._getValueByProperty(d);if("undefined"===typeof e)return!0;if(!(a._getValueByProperty(d)instanceof Space)||!a._getValueByProperty(d).length())return b._setPair(d,e),!0;if(!(e instanceof Space))return!0;b._setPair(d,e._getValueBySpace(a._getValueByProperty(d)))});return b};
Space.prototype.getTokens=function(){for(var a=this.toString(),b="K",c="",d=1,e=0,f=a.length,h=0;h<f-1;h++){var g=a.substr(h,1);0<e?(c+="E",e--):" "!==g&&"\n"!==g?("N"===b&&(b="K"),c+=b):" "===g?"V"===b?c+=b:"K"===b?(c+="S",b="V"):(d++,c+="N"):"K"===b?(b="N",d=1,c+="N"):"V"===b&&(a.substr(h+1,d)===Space.strRepeat(" ",d)?(c+="V",e=d):(b="N",d=1,c+="N"))}return c};Space.prototype.getTokensConcise=function(){return this.getTokens().replace(/[^\w\s]|(.)(?=\1)/gi,"")};
Space.prototype.getValues=function(){var a=[];this._pairs.forEach(function(b){a.push(b[1])});return a};Space.prototype.has=function(a){return!!this._getValueByProperty(a)};Space.prototype.__height=function(){return this.toString().match(/\n/g).length};Space.prototype.indexOf=function(a){if(!this._index[a])return-1;for(var b=this.length(),c=0;c<b;c++)if(this._pairs[c][0]===a)return c;return-1};Space.prototype.insert=function(a,b,c){this._setPair(a,b,c);return this};
Space.prototype.isEmpty=function(){return 0===this.length()};Space.prototype.isASet=function(){var a=!0,b={};this.each(function(c,d){if(b[c])return a=!1;b[c]=!0;if(d instanceof Space)return d.isASet()?!0:a=!1});return a};Space.prototype._typeCount=function(){var a=this.length();this.each(function(b,c){c instanceof Space&&(a+=c._typeCount())});return a};Space.prototype.last=function(){if(!this.length())return new Space;var a=this.length()-1;return(new Space).set(this._pairs[a][0],this._pairs[a][1])};
Space.prototype.lastProperty=function(){if(!this.length())return null;var a=this.length()-1;return this._pairs[a][0]};Space.prototype.lastValue=function(){if(!this.length())return null;var a=this.length()-1;return this._pairs[a][1]};Space.prototype.length=function(){return this._pairs.length};Space._load2=!0;
Space.prototype._load=function(a){if("string"===typeof a){if(!a.length)return this;Space._load2?this._loadFromString2(a):this._loadFromString(a);return this}if(a instanceof Space){var b=this;a.each(function(a,d){b._setPair(a,d)});return this}a instanceof Array?this._loadFromArray(a):this._loadFromObject(a)};Space.prototype._loadFromArray=function(a){for(var b in a){var c=a[b];"object"===typeof c?this._setPair("item",new Space(c)):this._setPair("item",c)}};
Space.prototype._loadFromObject=function(a){for(var b in a)if(Object.prototype.hasOwnProperty.call(a,b)){var c=a[b];"object"===typeof c?this._setPair(b,new Space(c)):this._setPair(b,c)}};
Space.prototype._loadFromString2=function(a){for(var b="",c="",d="",e="",f=0,h=0,g={"0":this},j=0,l=0,n=!1,p=a.length,m=0;m<p;m++){var k=a[m];if("\r"!==k&&(n||!("\n"===k||" "===k)))n||(n=d=!0),d?" "===k?(d=!1,e=!0,j=f>=h?h:f):"\n"===k?(d=!1,f>=h&&(f=h),h=f+1,g[h]=new Space,g[f]._setPair(b,g[h]),f=0,b=""):b+=k:e?l&&" "===k?(f++,l--):l?(g[j]._setPair(b,c.substr(0,c.length-1)),c="",d=!0,e=!1,b=k,l=0):"\n"===k?(l=j+1,f=0,m!==a.length-1&&(c+=k)):c+=k:"\n"!==k&&(" "===k?f++:(d=!0,b=k))}d&&g[f]._setPair(b,
new Space);e&&g[j]._setPair(b,c);return this};Space.prototype._loadFromString=function(a){a=a.replace(/^\s*/,"");a=a.replace(/\n\r/g,"\n");a=a.replace(/\n\n+/,"\n");a=a.split(/\n(?! )/g);var b,c;for(c in a){var d=a[c];(b=d.match(/^([^ ]+)(\n|$)/))?this._setPair(b[1],new Space(d.substr(b[1].length).replace(/\n /g,"\n"))):(b=d.match(/^([^ ]+) /))&&this._setPair(b[1],d.substr(b[1].length+1).replace(/\n /g,"\n"))}return this};Space.prototype.next=function(a){a=this.indexOf(a)+1;return this._getPropertyByIndex(a)};
Space.prototype.off=function(a,b){if(!this.events[a])return!0;for(var c in this.events[a])this.events[a][c]===b&&this.events[a].splice(c,1)};Space.prototype._objectCount=function(){var a=0;this.each(function(b,c){c instanceof Space&&(a+=1+c._objectCount())});return a};Space.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]);this.events[a].push(b)};
Space.prototype._patch=function(a){a instanceof Space||(a=new Space(a));var b=this;a.each(function(a,d){if("string"===typeof d)return""===d?b._delete(a):b.set(a,d,null,!0),!0;if("number"===typeof d)return b.set(a,d,null,!0),!0;if(d instanceof Space&&!d.length())return b._delete(a),!0;if(b._getValueByProperty(a)instanceof Space)return b._getValueByProperty(a)._patch(d),!0;b.set(a,new Space(d),null,!0)});return this};
Space.prototype.patch=function(a){this._patch(a);this.trigger("patch",a);this.trigger("change");return this};Space.prototype._patchOrder=function(a){a instanceof Space||(a=new Space(a));var b=this,c=this.clone();b._clear();a.each(function(a,e){b._setPair(a,c.get(a));e instanceof Space&&(e.length()&&c._getValueByProperty(a)instanceof Space)&&b._getValueByProperty(a)._patchOrder(e)});return this};
Space.prototype.patchOrder=function(a){this._patchOrder(a);this.trigger("patchOrder",a);this.trigger("change");return this};Space.prototype.pop=function(){if(!this.length())return null;var a=new Space,b=this._getPropertyByIndex(-1),c=this._getValueByProperty(b);a.set(b,c);this._delete(b);return a};Space.prototype.prepend=function(a,b){return this._setPair(a,b,0)};Space.prototype.prev=function(a){a=this.indexOf(a)-1;return this._getPropertyByIndex(a)};
Space.prototype.push=function(a){for(var b=this.length();this.get(b.toString());)b++;this._setPair(b.toString(),a);return this};Space.prototype._rename=function(a,b){var c=this.indexOf(a);this._setPair(b,this._getValueByProperty(a),c,!0);return this};Space.prototype.reload=function(a){this._pairs=[];this._index={};this._cache={};this._load(a);this.trigger("reload");return this};Space.prototype.rename=function(a,b){this._rename(a,b);a!==b&&this.trigger("rename",a,b);this.trigger("change");return this};
Space.prototype.renameAll=function(a,b,c){this.each(function(d,e,f){d===a&&this._setPair(b,e,f,!0);c&&e instanceof Space&&e.renameAll(a,b,c)});return this};Space.prototype.set=function(a,b,c,d){a=a.toString();if(Space.isXPath(a))this._setByXPath(a,b);else{var e=this.indexOf(a);-1<e?this._setPair(a,b,e,!0):this._setPair(a,b,c)}d||(this.trigger("set",a,b,c),this.trigger("change"));return this};
Space.prototype.setByIndexPath=function(a,b){if(!Space.isXPath(a)){var c=parseFloat(a);this.update(c,this._getPropertyByIndex(c),b);return this}c=Space.pathBranch(a);c=this.getByIndexPath(c);if(!c)return this;var d=parseFloat(Space.pathLeaf(a));c.update(d,c._getPropertyByIndex(d),b);return this};
Space.prototype._setByXPath=function(a,b){if(!a)return null;for(var c=a.toString().split(/ /g),d=this,e,f,h=c.length,g=0;g<h;g++){e=c[g];if((f=g===c.length-1)||!(d._getValueByProperty(e)instanceof Space)){var j;j=f?b:new Space;d.has(e)?(f=d.indexOf(e),d._setPair(e,j,f,!0)):d._setPair(e,j)}d=d.get(e)}return this};
Space.prototype._setPair=function(a,b,c,d){a=a.toString();void 0===c?this._pairs.push([a,b]):d&&this._pairs[c]?(d=this._pairs.splice(c,1,[a,b])[0][0],this._index[d]--):this._pairs.splice(c,0,[a,b]);if(d=this._index[a]){if(void 0!==c){for(var e=0;e<c&&this._pairs[e][0]!==a;e++);e===c&&(this._cache[a]=b)}}else this._cache[a]=b;this._index[a]=d?d+1:1};
Space.prototype.shift=function(){if(!this.length())return null;var a=this._getPropertyByIndex(0),b=new Space;b.set(a,this.get(a));this._deleteByIndex(0);return b};Space.prototype.sort=function(a){this._pairs=this._pairs.sort(a);return this};Space.prototype.split=function(a,b){var c=b?new Space:[],d=null;this.each(function(e,f){e===a&&(d&&(b?c.append(b,d):c.push(d)),d=new Space);if(!d)return!0;d.append(e,f)});d&&(b?c.append(b,d):c.push(d));return c};Space.prototype.tableOfContents=function(){return this.getProperties().join(" ")};
Space.prototype.toBinary=function(){for(var a="",b=this.toString(),c=0;c<b.length;c++){for(var d=parseFloat(b.substr(c,1).charCodeAt(0)).toString(2);8>d.length;)d="0"+d;a+=d}return a.replace(/0/g,"-").replace(/1/g,"|")};Space.prototype.toBinaryMatrixString=function(){var a="";this.toDecimalMatrix().forEach(function(b){b.forEach(function(b){for(b=b.toString(2);8>b.length;)b="0"+b;a+=b});a+="\n"});return a};
Space.prototype.toColumns=function(){for(var a=this.toString(),b=[],c=0,d=0,e=0,f=a.length,h=0;h<f;h++){var g=a[h];if("\n"===g){for(;c<d;)b[c]+=" ",c++;c=0;e++}else{if(!b[c]){b[c]="";for(var j=0;j<e;j++)b[c]+=" "}b[c]+=g;c++;c>d&&(d=c)}}return b};Space.prototype.toCsv=function(){return this.toDelimited(",")};
Space.prototype.toDecimalMatrix=function(){for(var a=this.__width(),b=this.toString().replace(/\n$/,"").split(/\n/g),c=[],d=0;d<b.length;d++){for(var e=b[d],f=[],h=e.length,g=0;g<a;g++)g<h?f.push(e.substr(g,1).charCodeAt(0)):f.push(0);c.push(f)}return c};Space.prototype.toDecimalMatrixString=function(){var a="";this.toDecimalMatrix().forEach(function(b){var c="";b.forEach(function(b){a+=c;a=10>b?a+("00"+b):9<b&&100>b?a+("0"+b):a+b;c=" "});a+="\n"});return a};
Space.prototype.toDelimited=function(a,b){var c="",d=RegExp('(\\n|\\"|\\'+a+")"),e=function(a){return!a.match(d)?a:'"'+a.replace(/\"/g,'""')+'"'};b=b||[];var f={};b.length||this.each(function(a,c){if(!(c instanceof Space))return!0;c.each(function(a){if(f[a])return!0;b.push(a);f[a]=!0})});b.forEach(function(b){c+=a+e(b)});c=c.substr(1)+"\n";this.each(function(d,f){if(!(f instanceof Space))return!0;var j="";b.forEach(function(b){b=f.get(b)||"";j+=a+e(b.toString())});c+=j.substr(1)+"\n"});return c};
Space.prototype.toggle=function(a,b,c){this.get(a)===b?this.set(a,c):this.set(a,b);return this};Space.prototype.toJavascript=function(a){var b="new Space('"+this.toString().replace(/\n/g,"\\n").replace(/\'/g,"\\'")+"')";return a?b.replace(/\\n/g,"\\n\\\n"):b};Space.prototype.toJSON=function(){return JSON.stringify(this.toObject())};Space.prototype.toObject=function(){var a={};this.each(function(b,c){a[b]=c instanceof Space?c.toObject():c});return a};
Space.prototype.toQueryString=function(){var a="",b="";this.each(function(c,d){a+=b+encodeURIComponent(c)+"="+encodeURIComponent(d);b="&"});return a};Space.prototype.toShapes=function(a){a=a||0;var b="V\n";this.each(function(c,d){if("undefined"===typeof d)return b+="\n",!0;b+=Space.strRepeat(" ",a)+"O";b=d instanceof Space?b+d.toShapes(a+1):"object"===typeof d?b+(new Space(d)).toShapes(a+1):""===d.toString()?b+" \n":b+"[]\n"});return b};Space.prototype.toSsv=function(){return this.toDelimited(" ")};
Space.prototype.toString=function(a){a=a||0;var b="";this.each(function(c,d){if("undefined"===typeof d)return b+="\n",!0;b+=Space.strRepeat(" ",a)+c;b=d instanceof Space?b+("\n"+d.toString(a+1)):"object"===typeof d?b+("\n"+(new Space(d)).toString(a+1)):""===d.toString()?b+" \n":d.toString().match(/\n/)?b+(" "+d.toString().replace(/\n/g,"\n"+Space.strRepeat(" ",a+1))+"\n"):b+(" "+d.toString()+"\n")});return b};Space.prototype.toTsv=function(){return this.toDelimited("\t")};Space.prototype.toURL=function(){return encodeURIComponent(this.toString())};
Space.prototype.__transpose=function(a){var b="";this.each(function(c,d){var e=new Space(a.toString());e.every(function(a,b,c){d._getValueByProperty(b)&&this._setPair(a,d._getValueByProperty(b),c,!0)});b+=e.toString()});return new Space(b)};Space.prototype.trigger=function(a){if(!this.events[a])return!0;var b=Array.prototype.slice.call(arguments),c;for(c in this.events[a])this.events[a][c].apply(this,b.slice(1))};Space.prototype.update=function(a,b,c){this._setPair(b,c,a,!0);return this};
Space.prototype.__width=function(){var a=0;this.toString().split(/\n/g).forEach(function(b){b.length>a&&(a=b.length)});return a};"undefined"!==typeof exports&&(module.exports=Space);
